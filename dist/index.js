var w=Object.create;var c=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var O=(i,e)=>{for(var t in e)c(i,t,{get:e[t],enumerable:!0})},u=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of S(e))!E.call(i,a)&&a!==t&&c(i,a,{get:()=>e[a],enumerable:!(r=x(e,a))||r.enumerable});return i};var d=(i,e,t)=>(t=i!=null?w(k(i)):{},u(e||!i||!i.__esModule?c(t,"default",{value:i,enumerable:!0}):t,i)),v=i=>u(c({},"__esModule",{value:!0}),i);var j={};O(j,{DataTypes:()=>m,Operator:()=>g,default:()=>N});module.exports=v(j);var F={STRING:function(i){let e={type:"string"};return i&&(e.max=i),e},NUMBER:function(){return{type:"number"}}},m=F;var n=d(require("fs"),1);var h=d(require("fs"),1),o=class{constructor(e,t,r){this.logname=e,this.filename=t,this.model=r}save(){try{h.default.renameSync("./data/log/"+this.logname,"./data/log/"+this.model+".old.txt");let e=h.default.readFileSync("./data/log/"+this.model+".old.txt",{encoding:"utf8"}).split(`
`);e.pop(),this.data=JSON.parse(h.default.readFileSync("./data/"+this.filename,{encoding:"utf8"}));for(let t of e)this.addLine(t);h.default.writeFileSync("./data/"+this.filename,JSON.stringify(this.data)),h.default.writeFileSync("./data/log/"+this.logname,"",{flag:"a+"}),h.default.rmSync("./data/log/"+this.model+".old.txt")}catch(e){console.error(e)}}addLine(e){let[t,r]=e.split(" ");switch(r=JSON.parse(r),t){case"add":this.data.push(r);break;case"update":let a=this.data.find(s=>s.id===r.id);a=r;break;case"delete":this.data.filter(s=>s.id!==r.id);break}}};var l=class{constructor(e,t){this.name=e,this.schema=t,this.filename=e+".json",this.logname=e+".txt",this.deepSave=new o(this.logname,this.filename,e),n.default.existsSync("./data/"+this.filename)?this.data=JSON.parse(n.default.readFileSync("./data/"+this.filename,{flag:"a+"})):(this.data=[],n.default.writeFileSync("./data/"+this.filename,"[]",{flag:"a+"})),n.default.existsSync("./data/log/"+this.logname)||n.default.writeFileSync("./data/log/"+this.logname,"",{flag:"a+"}),this.deepSaveLauncher(),this.currentId=this.data.length>0?Math.max(...this.data.map(r=>r.id)):0}save(e,t){try{n.default.appendFileSync("./data/log/"+this.logname,e+" "+JSON.stringify(t)+`
`)}catch(r){throw new Error(r.message)}}deepSaveLauncher(){setTimeout(()=>{this.deepSave.save()},5e3)}deep;findAll(e){return!e.where&&this.data.length>0?this.data:this.data.filter(t=>this.checkWhereClause(t,e))}findOne(e){return!e.where&&this.data.length>0?this.data[0]:this.data.find(t=>this.checkWhereClause(t,e))}create(e){try{this.checkFieldExist(e),this.checkFormat(e)}catch(r){throw r}let t={...e,id:++this.currentId};this.data.push(t);try{this.save("add",t)}catch(r){throw this.data.pop(),new Error(r.message)}return t}updateOne(e,t){let r=this.findOne(t),a=structuredClone(r);try{this.checkFieldExist(e),this.checkFormat(e)}catch(s){throw s}Object.assign(r,e);try{this.save("update",r)}catch(s){throw r=a,new Error(s.message)}}destroy(e){if(!e.where&&this.data.length>0)return 0;let t=this.data.length,r=this.findOne(e);this.data=this.data.filter(a=>!checkWhereClause(a,e));try{this.save("delete",r)}catch(a){throw this.data.push(r),new Error(a.message)}return t-this.data.length}checkWhereClause(e,t){for(let[r,a]of Object.entries(t.where))if(typeof e[r]=="number"&&(a=parseInt(a)),a.like){if(!new RegExp(a.like.replaceAll("%",".*")).test(e[r]))return!1}else if(a.is){if(!Array.isArray(a.is))throw new Error("Is operator required an array value");if(!a.is.includes(e[r]))return!1}else if(e[r]!==a)return!1;return!0}checkFormat(e){for(let[t,r]of Object.entries(e)){if(typeof r!==this.schema[t].type.type)throw new Error("Error : property "+t+" must be of type "+this.schema[t].type.type);if(this.schema[t].type.max&&r.length>this.schema[t].type.max)throw new Error("Error : property "+t+" must have "+this.schema[t].type.max+" at most");if(this.schema[t].unique&&!this.checkUnique(t,r))throw new Error("Error : property "+t+" must be unique")}return!0}checkFieldExist(e){for(let t of Object.keys(e))if(!this.schema[t])throw new Error("Error : property "+t+" does not exist on "+this.name);return!0}checkUnique(e,t){let r={};return r[e]=t,!this.findOne({where:r})}};var f=d(require("fs"),1),p=class{constructor({namespace:e,encrypt:t}={namespace:"data",encrypt:!1}){this.namespace=e,this.encrypt=t,f.default.existsSync("./"+this.namespace)||f.default.mkdirSync("./"+this.namespace+"/log",{recursive:!0})}createModel(e,t){return new l(e,t,this.namespace)}},y=p;var b={Like:"like",Is:"is"},g=b;var N=y;0&&(module.exports={DataTypes,Operator});

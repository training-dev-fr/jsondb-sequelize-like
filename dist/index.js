var O=Object.create;var u=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var q=(e,t)=>{for(var s in t)u(e,s,{get:t[s],enumerable:!0})},w=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of A(t))!F.call(e,i)&&i!==s&&u(e,i,{get:()=>t[i],enumerable:!(r=C(t,i))||r.enumerable});return e};var l=(e,t,s)=>(s=e!=null?O(D(e)):{},w(t||!e||!e.__esModule?u(s,"default",{value:e,enumerable:!0}):s,e)),U=e=>w(u({},"__esModule",{value:!0}),e);var he={};q(he,{DataTypes:()=>b,Operator:()=>S,default:()=>oe});module.exports=U(he);var L={STRING:function(e){let t={type:"string"};return e&&(t.max=e),t},NUMBER:function(){return{type:"number"}}},b=L;var c=l(require("fs"),1);var n=l(require("fs"),1),o=class{constructor(t,s,r,i){this.logname=t,this.filename=s,this.model=r,this.namespace=i,n.default.existsSync("./"+this.namespace+"/history/"+this.model+".old.txt")&&this.save(!1)}save(t=!0){try{t&&n.default.renameSync("./"+this.namespace+"/history/"+this.logname,"./"+this.namespace+"/history/"+this.model+".old.txt");let s=n.default.readFileSync("./"+this.namespace+"/history/"+this.model+".old.txt",{encoding:"utf8"}).split(`
`);s=s.filter(r=>r!=""),this.data=JSON.parse(n.default.readFileSync("./"+this.namespace+"/"+this.filename,{encoding:"utf8"}));for(let r of s)this.addLine(r);n.default.writeFileSync("./"+this.namespace+"/"+this.filename,JSON.stringify(this.data)),n.default.writeFileSync("./"+this.namespace+"/history/"+this.logname,"",{flag:"a+"}),n.default.rmSync("./"+this.namespace+"/history/"+this.model+".old.txt")}catch(s){console.error(s)}}addLine(t){let[s,r]=t.split(" ");switch(r=JSON.parse(r),s){case"add":this.data.push(r);break;case"update":let i=this.data.find(a=>a.id===r.id);i=r;break;case"delete":this.data.filter(a=>a.id!==r.id);break}}};var h=e=>typeof e=="string",d=e=>typeof e=="number",j=(e,t)=>t.test(e),P=(e,t)=>!t.test(e),T=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),V=e=>{try{return new URL(e),!0}catch{return!1}},J=e=>k(e)||v(e),k=e=>/^(\d{1,3}\.){3}\d{1,3}$/.test(e),v=e=>/^[\da-fA-F:]+$/.test(e),R=e=>/^[A-Za-z]+$/.test(e),$=e=>/^[A-Za-z0-9]+$/.test(e),M=e=>/^-?\d+(\.\d+)?$/.test(e),W=e=>Number.isInteger(e),E=e=>d(e)&&!Number.isInteger(e),B=e=>E(e),z=e=>h(e)&&e===e.toLowerCase(),Z=e=>h(e)&&e===e.toUpperCase(),G=e=>e!=null,H=e=>e==null,K=e=>e!==""&&e!==null&&e!==void 0,Q=(e,t)=>e===t,X=(e,t)=>h(e)&&e.includes(t),Y=(e,t)=>h(e)&&!e.includes(t),_=(e,t)=>Array.isArray(t)&&t.includes(e),N=(e,t)=>Array.isArray(t)&&!t.includes(e),ee=(e,t)=>h(e)&&e.length>=t[0]&&e.length<=t[1],te=e=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),re=e=>!isNaN(Date.parse(e)),se=(e,t)=>new Date(e)>new Date(t),ae=(e,t)=>new Date(e)<new Date(t),ie=(e,t)=>d(e)&&e>=t,ne=(e,t)=>d(e)&&e<=t,g=(e,t,s)=>{let r=[];for(let[i,a]of Object.entries(s))if(typeof a=="function")try{a(e)}catch(x){r.push(x)}else switch(i){case"is":j(e,a)||r.push(new Error(t+" must match pattern : "+a));break;case"not":P(e,a)||r.push(new Error(t+" must not match pattern : "+a));break;case"isUrl":V(e)||r.push(new Error(t+" must be url format"));break;case"isEmail":T(e)||r.push(new Error(t+" must be email format"));break;case"isIP":J(e)||r.push(new Error(t+" must be IPv4 or IPv6 format"));break;case"isIPv4":k(e)||r.push(new Error(t+" must be IPv4 format"));break;case"isIPv6":v(e)||r.push(new Error(t+" must be IPv6 format"));break;case"isAlpha":R(e)||r.push(new Error(t+" must contains only alpha chars"));break;case"isAlphanumeric":$(e)||r.push(new Error(t+" must contains only alpha and numeric chars"));break;case"isNumeric":M(e)||r.push(new Error(t+" must contains only numeric chars"));break;case"isInt":W(e)||r.push(new Error(t+" must be Integer"));break;case"isFloat":E(e)||r.push(new Error(t+" must be Decimal"));break;case"isDecimal":B(e)||r.push(new Error(t+" must be Float"));break;case"isLowerCase":z(e)||r.push(new Error(t+" must be in lowerCase"));break;case"isUpperCase":Z(e)||r.push(new Error(t+" must be in upperCase"));break;case"notNull":G(e)||r.push(new Error(t+" must be not null"));break;case"isNull":H(e)||r.push(new Error(t+" must be null"));break;case"notEmpty":K(e)||r.push(new Error(t+" must be not empty"));break;case"equals":Q(e,a)||r.push(new Error(t+" must be equals to "+a));break;case"contains":X(e,a)||r.push(new Error(t+" must contains "+a));break;case"notContains":Y(e,a)||r.push(new Error(t+" must not contains "+a));break;case"isIn":_(e,a)||r.push(new Error(t+" must be in "+JSON.stringify(a)));break;case"notIn":N(e,a)||r.push(new Error(t+" must not be in "+JSON.stringify(a)));break;case"len":ee(e,a)||r.push(new Error(t+" must be "+a+" chars length max"));break;case"isUUID":te(e)||r.push(new Error(t+" must be UUID"));break;case"isDate":re(e)||r.push(new Error(t+" must be a date"));break;case"isAfter":se(e,a)||r.push(new Error(t+" must be greater than "+a));break;case"isBefore":ae(e,a)||r.push(new Error(t+" must be lower than "+a));break;case"min":ie(e,a)||r.push(new Error(t+" must be greater than "+a));break;case"max":ne(e,a)||r.push(new Error(t+" must be lower than "+a));break;default:r.push(new Error("validator "+t+" is not implemented manage by jsondb tools"));break}return r};var f=class{constructor(t,s,{namespace:r,deepSaveTiming:i=1e3*60*5}){this.name=t,this.schema=s,this.filename=t+".json",this.logname=t+".txt",this.namespace=r,this.deepSaveTiming=i,this.deepSave=new o(this.logname,this.filename,this.name,this.namespace),c.default.existsSync("./"+this.namespace+"/"+this.filename)?this.data=JSON.parse(c.default.readFileSync("./"+this.namespace+"/"+this.filename,{flag:"a+"})):(this.data=[],c.default.writeFileSync("./"+this.namespace+"/"+this.filename,"[]",{flag:"a+"})),c.default.existsSync("./"+this.namespace+"/history/"+this.logname)||c.default.writeFileSync("./"+this.namespace+"/history/"+this.logname,"",{flag:"a+"}),this.deepSaveLauncher(),this.currentId=this.data.length>0?Math.max(...this.data.map(a=>a.id)):0}flush(){this.deepSave.save()}save(t,s){try{c.default.appendFileSync("./"+this.namespace+"/history/"+this.logname,t+" "+JSON.stringify(s)+`
`)}catch(r){throw new Error(r.message)}}deepSaveLauncher(){setTimeout(()=>{this.deepSave.save(),this.deepSaveLauncher()},this.deepSaveTiming)}findAll(t){return!t.where&&this.data.length>0?this.data:this.data.filter(s=>this.checkWhereClause(s,t))}findOne(t){return!t.where&&this.data.length>0?this.data[0]:this.data.find(s=>this.checkWhereClause(s,t))}create(t){try{let r=[];if(this.addDefaultValue(t),r=r.concat(this.checkFieldExist(t)),r=r.concat(this.checkFormat(t)),r=r.concat(this.checkRequired(t)),r=r.concat(this.checkValidator(t)),r.length>0)throw new Error("Validation failed",{cause:r})}catch(r){throw r}let s={...t,id:this.currentId+1};this.data.push(s);try{this.save("add",s),this.currentId++}catch(r){throw this.data.pop(),new Error(r.message)}return s}updateOne(t,s){let r=this.findOne(s),i=structuredClone(r);Object.assign(r,t);try{let a=[];a=a.concat(this.checkFieldExist(r)),a=a.concat(this.checkFormat(r)),a=a.concat(this.checkRequired(r)),a=a.concat(this.checkValidator(r))}catch(a){throw a}try{return this.save("update",r),r}catch(a){throw r=i,new Error(a.message)}}destroy(t){if(!t.where&&this.data.length>0)return 0;let s=this.data.length,r=this.findOne(t);this.data=this.data.filter(i=>!checkWhereClause(i,t));try{this.save("delete",r)}catch(i){throw this.data.push(r),new Error(i.message)}return s-this.data.length}checkWhereClause(t,s){for(let[r,i]of Object.entries(s.where))if(i.like){if(!this.checkLikeClause(t[r],i.like))return!1}else if(i.in){if(!this.checkInClause(t[r],i.in))return!1}else if(t[r]!==i)return!1;return!0}checkLikeClause(t,s){if(typeof s!="string")throw new Error("Like operator required an string value");return new RegExp(s.replaceAll("%",".*")).test(t)}checkInClause(t,s){if(!Array.isArray(s))throw new Error("In operator required an array value");return s.includes(t)}checkFormat(t){let s=[];for(let[r,i]of Object.entries(t))typeof i!==this.schema[r].type.type&&s.push(new Error("Error : property "+r+" must be of type "+this.schema[r].type.type)),this.schema[r].type.max&&i.length>this.schema[r].type.max&&s.push(new Error("Error : property "+r+" must have "+this.schema[r].type.max+" at most")),this.schema[r].unique&&(this.checkUnique(r,i)||s.push(new Error("Error : property "+r+" must be unique")));return s}checkRequired(t){let s=[],r=Array.from(this.schema).filter(i=>i.required&&i.required===!0);for(let[i,a]of Object.entries(r))t[i]||s.push(new Error("Error : property "+i+" is required"));return s}checkFieldExist(t){let s=[];for(let r of Object.keys(t))this.schema[r]||s.push(new Error("Error : property "+r+" does not exist on "+this.name));return s}checkUnique(t,s){let r={};return r[t]=s,!this.findOne({where:r})}addDefaultValue(t){for(let[s,r]of Object.entries(this.schema))r.defaultValue&&!t[s]&&(t[s]=r.defaultValue,console.log(t[s]))}checkValidator(t){let s=[];for(let[r,i]of Object.entries(this.schema))i.validate&&(s=s.concat(g(t[r],r,i.validate)));return s}},y=f;var p=l(require("fs"),1),m=class{constructor({namespace:t="data",deepSaveTiming:s=1e3*60*5}){this.namespace=t,this.deepSaveTiming=s,p.default.existsSync("./"+this.namespace)||p.default.mkdirSync("./"+this.namespace+"/history",{recursive:!0})}define(t,s){return new y(t,s,this.namespace,this.deepSaveTiming)}},I=m;var ce={like:"like",in:"in"},S=ce;var oe=I;0&&(module.exports={DataTypes,Operator});
